<!doctype html> <html lang="en-US"> <head>     <meta charset="UTF-8">     <meta name="viewport" content="width=device-width, initial-scale=1">     <link rel="profile" href="https://gmpg.org/xfn/11">  	<title>Hackthebox Challenge &#8211; Broken Decryptor &#8211; 0xlimE Writeup blog</title> <meta name='robots' content='max-image-preview:large' /> <link rel='dns-prefetch' href='//s.w.org' /> <link href='https://fonts.gstatic.com' crossorigin rel='preconnect' /> <link rel="alternate" type="application/rss+xml" title="0xlimE Writeup blog &raquo; Feed" href="https://0xli.me/?feed=rss2" /> <link rel="alternate" type="application/rss+xml" title="0xlimE Writeup blog &raquo; Comments Feed" href="https://0xli.me/?feed=comments-rss2" /> 		<script>
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/0xli.me\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.8.2"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([10084,65039,8205,55357,56613],[10084,65039,8203,55357,56613])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script> 		<style> img.wp-smiley, img.emoji { 	display: inline !important; 	border: none !important; 	box-shadow: none !important; 	height: 1em !important; 	width: 1em !important; 	margin: 0 .07em !important; 	vertical-align: -0.1em !important; 	background: none !important; 	padding: 0 !important; } </style> 	<link rel='stylesheet' id='wp-block-library-css'  href='./css/dist-block-library-style.min.css' media='all' /> <link rel='stylesheet' id='wp_meliora-style-css'  href='./css/wp-meliora-style.css' media='all' /> <link rel='stylesheet' id='dashicons-css'  href='./css/q8h-dashicons.min.css' media='all' /> <link rel='stylesheet' id='enlighterjs-css'  href='./css/enlighter-cache-enlighterjs.min.css' media='all' />         <script>
            /* <![CDATA[ */
            var rcewpp = {
                "ajax_url":"https://0xli.me/wp-admin/admin-ajax.php",
                "nonce": "34564bfd5b",
                "home_url": "https://0xli.me/",
                "settings_icon": 'https://0xli.me/wp-content/plugins/export-wp-page-to-static-html/admin/images/settings.png',
                "settings_hover_icon": 'https://0xli.me/wp-content/plugins/export-wp-page-to-static-html/admin/images/settings_hover.png'
            };
            /* ]]\> */
        </script>         <link rel="https://api.w.org/" href="https://0xli.me/index.php?rest_route=/" /><link rel="alternate" type="application/json" href="https://0xli.me/index.php?rest_route=/wp/v2/pages/671" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://0xli.me/xmlrpc.php?rsd" /> <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://0xli.me/wp-includes/wlwmanifest.xml" />  <meta name="generator" content="WordPress 5.8.2" /> <link rel="canonical" href="https://0xli.me/?page_id=671" /> <link rel='shortlink' href='https://0xli.me/?p=671' /> <link rel="alternate" type="application/json+oembed" href="https://0xli.me/index.php?rest_route=%2Foembed%2F1.0%2Fembed&#038;url=https%3A%2F%2F0xli.me%2F%3Fpage_id%3D671" /> <link rel="alternate" type="text/xml+oembed" href="https://0xli.me/index.php?rest_route=%2Foembed%2F1.0%2Fembed&#038;url=https%3A%2F%2F0xli.me%2F%3Fpage_id%3D671&#038;format=xml" />     <style>         :root {	 	            --wp-meliora-primary-color: #FFBA9D; 	            --wp-meliora-base-font-color: #777777; 	            --wp-meliora-heading-color: #474747; 	             	            --wp-meliora-link-normal-color: #000 ; 	            --wp-meliora-link-hover-color: #FFBA9D ; 			}    </style> 	<style>.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style><link rel="icon" href="./images/limewirelogo-96x96.png" sizes="32x32" /> <link rel="icon" href="./images/limewirelogo-300x300.png" sizes="192x192" /> <link rel="apple-touch-icon" href=".images/limewirelogo-300x300.png" /> <meta name="msapplication-TileImage" content=".images/limewirelogo-300x300.png" /> 		<style id="wp-custom-css"> 			.wp-block-image img {     max-width: 100%;     margin-left: auto;     margin-right: auto;     display: block; 		margin-bottom 0px; 		 } .wp-block-image figcaption {     margin-top: 0em; } figure figcaption {     text-align: center; 		font-size: 14px; 		font-weight: lighter; 		color: grey; } code, kbd, samp{ 	color: darkgreen; } 		</style> 		<style id="kirki-inline-styles">.h1,h1{font-family:Roboto Mono;font-size:24px;font-weight:300;line-height:1.5;}.h2,h2{font-size:calc(24px - 0.3125rem);font-weight:300;font-family:Roboto Mono;line-height:1.5;}.h3,h3{font-size:calc(24px - 0.38rem);font-weight:300;font-family:Roboto Mono;}.h4,h4{font-size:calc(24px - 0.44rem);font-weight:300;font-family:Roboto Mono;}.h5,h5{font-size:calc(24px - 0.52rem);font-weight:300;font-family:Roboto Mono;}.h6,h6{font-size:calc(24px - 0.6rem);font-weight:300;font-family:Roboto Mono;}body{font-size:16px;line-height:1.5;font-family:Roboto Mono;}.c-post__content__main a{font-family:Roboto Mono;font-size:16px;font-weight:300;line-height:1.5;}/* cyrillic-ext */ @font-face {   font-family: 'Roboto Mono';   font-style: normal;   font-weight: 300;   font-display: swap;   src: url(./fonts/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_gPq_SeW-AJi8SKQuQ4Y.woff) format('woff');   unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F; } /* cyrillic */ @font-face {   font-family: 'Roboto Mono';   font-style: normal;   font-weight: 300;   font-display: swap;   src: url(./fonts/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_gPq_QOW-AJi8SKQuQ4Y.woff) format('woff');   unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116; } /* greek */ @font-face {   font-family: 'Roboto Mono';   font-style: normal;   font-weight: 300;   font-display: swap;   src: url(./fonts/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_gPq_R-W-AJi8SKQuQ4Y.woff) format('woff');   unicode-range: U+0370-03FF; } /* vietnamese */ @font-face {   font-family: 'Roboto Mono';   font-style: normal;   font-weight: 300;   font-display: swap;   src: url(./fonts/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_gPq_S-W-AJi8SKQuQ4Y.woff) format('woff');   unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+1EA0-1EF9, U+20AB; } /* latin-ext */ @font-face {   font-family: 'Roboto Mono';   font-style: normal;   font-weight: 300;   font-display: swap;   src: url(./fonts/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_gPq_SuW-AJi8SKQuQ4Y.woff) format('woff');   unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF; } /* latin */ @font-face {   font-family: 'Roboto Mono';   font-style: normal;   font-weight: 300;   font-display: swap;   src: url(./fonts/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_gPq_ROW-AJi8SKQu.woff) format('woff');   unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD; }</style></head>  <body class="page-template-default page page-id-671 no-sidebar"> <div id="page" class="o-page site is-content-sidebar">     <a class="skip-link screen-reader-text" href="#primary">Skip to content</a>     <header id="masthead" class="c-header site-header">         <div class="c-header__main u-default-max-width">             <div class="c-header__branding"> 				            <p class="c-header__branding__title site-title h1">                 <a class="c-header__branding__title__link h1" href="https://0xli.me/" rel="home">0xlimE Writeup blog</a>             </p> 		            </div><!-- .site-branding -->              <nav id="site-navigation" class="c-header__navigation main-navigation">                 <button aria-label="Toggle menu" class="c-header__navigation__toggle js-menu-toggle menu-toggle" aria-controls="primary-menu" aria-expanded="false">                     <span class="dashicons dashicons-menu-alt"></span></button> 				<ul id="primary-menu" class="menu js-primary-menu"><li class='menu-item menu-item-type-custom menu-item-object-custom menu-item-home'><a href="https://0xli.me">Home</a></li> <li class='menu-item menu-item-type-post_type menu-item-object-page'><a href="https://0xli.me/?page_id=427">Passwords</a></li> <li class='menu-item menu-item-type-taxonomy menu-item-object-category'><a href="https://0xli.me/?cat=23">HTB Machines</a></li> <li class='menu-item menu-item-type-taxonomy menu-item-object-category'><a href="https://0xli.me/?cat=24">HTB Challenges</a></li> <li class='menu-item menu-item-type-taxonomy menu-item-object-category'><a href="https://0xli.me/?cat=34">CTF</a></li> </ul>            </nav><!-- #site-navigation --> 			        </div>     </header><!-- #masthead -->      <main id="primary" class="site-main">         <div class="site-main__container default-max-width">             <div class="site-main__content"> 				 <article id="post-671" class="c-page post-671 page type-page status-publish has-post-thumbnail hentry">      <header class="c-page__header entry-header"> 		<h1 class="c-page__title entry-title">Hackthebox Challenge &#8211; Broken Decryptor</h1>    </header><!-- .entry-header -->      <div class="entry-content"> 		 <p>Solving the medium hackthebox crypto challenge &#8211; Broken Decryptor.</p>    <figure class="wp-block-image size-large"><img loading="lazy" width="922" height="309" src="./images/billede-5.png" alt="" class="wp-image-672"/></figure>    <p>The challenge runs on a server and we get the source code for the server. We download the file and it only contains the following script:</p>    <pre class="EnlighterJSRAW" data-enlighter-language="python" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">#!/usr/bin/python3 import socketserver from Crypto.Cipher import AES from Crypto.Util import Counter import os  key = os.urandom(0x10).replace(b'\x00', b'\xff') iv = os.urandom(0x10).replace(b'\x00', b'\xff')  def xor(a, b):     return bytes([_a ^ _b for _a, _b in zip(a, b)])  def unhex(msg):     return bytes.fromhex(msg)  def encrypt(data):     ctr = Counter.new(128, initial_value=int(iv.hex(), 16))     crypto = AES.new(key, AES.MODE_CTR, counter=ctr)     if type(data) != bytes:         data = data.encode()     otp = os.urandom(len(data)).replace(b'\x00', b'\xff')     return xor(crypto.encrypt(data), otp)  def decrypt(data):     ctr = Counter.new(128, initial_value=int(iv.hex(), 16))     crypto = AES.new(key, AES.MODE_CTR, counter=ctr)     return crypto.decrypt(data.encode())  def get_flag():     flag = open('flag.txt', 'r').read().strip()     return encrypt(flag)  def send_msg(s, msg):     s.send(msg.encode())  def get_input(s, msg):     send_msg(s, msg)     data = b''     while (recv := s.recv(0x1000)) != b'':         data += recv         if data.endswith(b'\n'):             break     data = data.strip()     return data.decode()  def main(s):     while True:         send_msg(s, '1) Get flag\n')         send_msg(s, '2) Encrypt Message\n')         send_msg(s, '3) Decrypt Message\n')         try:             opt = get_input(s, 'Your option: ')             if opt == '1':                 send_msg(s, get_flag().hex()+'\n')             elif opt == '2':                 pt = get_input(s, 'Enter plaintext: ')                 send_msg(s, encrypt(unhex(pt)).hex()+'\n')             elif opt == '3':                 ct = get_input(s, 'Enter ciphertext: ')                 send_msg(s, decrypt(unhex(ct)).hex()+'\n')             else:                 send_msg(s, 'Invalid option!\n')         except:             send_msg(s, 'An error occured.')             return  class Handler(socketserver.BaseRequestHandler):     def handle(self):         main(self.request)  if __name__ == '__main__':     socketserver.ThreadingTCPServer.allow_reuse_address = True     server = socketserver.ThreadingTCPServer(('0.0.0.0', 1337), Handler)     server.serve_forever() </pre>    <p>Ok so there are a lot of points to go over. Here is the most important stuff to notice.</p>    <ul><li>There are two types of encryption going on. <code>AES_CTR</code> and <code>OTP</code>, they both boil down to having a <code>keystream</code> that is xor&#8217;ed with the plaintext.</li><li>The encrypt function first encrypts the input with the <code>AES_CTR</code> and after that the encrypts with the <code>OTP</code>. </li><li>The decryption function simply returns an error (wrong types), so it is completely useless (hence the name <em>Broken Decryptor</em>)</li></ul>    <p>So by looking at the AES mode of operation on wiki: <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Counter_(CTR)">https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Counter_(CTR)</a> we can see that because we are reusing the counter (<code>CTR</code>) We know that the AES keystream will be the same for each call to encrypt. However we have the problem that the result is also encrypted by the OTP.</p>    <p>This is where the <em>vulnerability</em> in the OTP implementation comes into play. The specific line that introduces the vulnerability is:<br><code>otp&nbsp;=&nbsp;os.urandom(len(data)).replace(b'\x00',&nbsp;b'\xff')</code><br>The mistake is replacing all null bytes with <code>\xff</code>. This introduces a potential for leaks.</p>    <p>We know that since null bytes cannot exist in the <code>OTP</code>, the plaintext (in this context after the AES encryption) can never encrypt to itself when being encrypted by the <code>OTP </code>after requesting it. </p>    <p>What this means is that we can get the plaintext (again after AES encryption) by keeping a count of which bytes we have seen for each  plaintext character, and when we have seen all possible bytes but 1, for each plaintext character, we know that the missing byte is the plaintext version.</p>    <p>This means by requesting the flag over and over again, until we have seen 255 distinct hex values for each character, we can know what the flag (still encrypted by AES) is. Thats nice, but how do we get the AES key then?</p>    <p>The goal is not really to get the key, but rather the <em>keystream</em>, which is the same for all calls to AES encryption. Since the counter is reused as the IV. This means that if we ask to encrypt a series of null bytes (0000000000000000000) With the same length as the flag,  in the same manner as above, we can get out the keystream and finally xor the result with the encrypted flag.</p>    <p>I implemented this in python3 and the script is here:</p>    <pre class="EnlighterJSRAW" data-enlighter-language="python" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">from pwn import * import sys  ip = "167.71.143.20" port = 31524  io = remote(ip, port) io.recvuntil('Your option:')  requests = 0 flagSet = [set([chr(i).encode('Latin-1').hex() for i in range(256)]) for x in range(15)] #flagSet=  [{'0b'}, {'27'}, {'e1'}, {'ae'}, {'60'}, {'64'}, {'ab'}, {'4b'}, {'2f'}, {'d0'}, {'eb'}, {'07'}, {'2f'}, {'bb'}, {'39'}] encSet = [set([chr(i).encode('Latin-1').hex() for i in range(256)]) for x in range(15)] #encSet= [{'43'}, {'73'}, {'a3'}, {'d5'}, {'51'}, {'32'}, {'f4'}, {'39'}, {'1c'}, {'a5'}, {'cf'}, {'34'}, {'0c'}, {'9a'}, {'44'}]  #Stolen from challenge def xor(a, b):     return bytes([_a ^ _b for _a, _b in zip(a, b)]) #stolen from challenge. def unhex(msg):     return bytes.fromhex(msg)  def getFlag(io):     io.clean(0)     io.sendline(b'1\n')     flag = io.recvuntil("\n1) Get flag",drop=True)     global requests     requests+=1      return flag  def getEnc(io):     io.clean(0)     io.sendline(b'2\n')     io.recvuntil(b'Enter plaintext: ')     io.sendline(b'000000000000000000000000000000\n')     flag = io.recvuntil("\n1) Get flag",drop=True)      global requests     requests+=1     return flag   def removeFromSet(strIn,setIn):     isDone=True     hexes = [strIn[i:i+2].decode() for i in range(0,len(strIn),2)]     for i in range(len(hexes)):           if(hexes[i] in setIn[i]):             setIn[i].remove(hexes[i])             isDone=False         elif(len(setIn[i])>1):             isDone=False     #show progress:             toprint=""     for i in setIn:         toprint = toprint+" "+str(len(i))     global requests     print("total requests: "+str(requests)+". Resulting array:"+toprint)     sys.stdout.write("\033[F")     sys.stdout.write("\033[K")          return(isDone)   def BFFlag(io):     print("bruteforcing flag, we are done when we have all 1's in array...")     finalFlag=""     while True:          flag = getFlag(io)         res = removeFromSet(flag,flagSet)         if res:             for x in flagSet:                 finalFlag = finalFlag+x.pop()             print("flag is: "+finalFlag)             return finalFlag  def BFEnc(io):     finalEnc=""     print("bruteforcing enc, we are done when we have all 1's in array...")     while True:         enc = getEnc(io)         res = removeFromSet(enc,encSet)         if res:             for x in encSet:                 finalEnc = finalEnc+x.pop()             print("enc is: "+finalEnc)             return finalEnc  finalFlag = BFFlag(io) finalEnc = BFEnc(io)  print("got result, now xoring")    print("flag was "+finalFlag) print("enc was "+finalEnc) print() print("xoring them together gives the flag:") print(xor(unhex(finalFlag),unhex(finalEnc)))  </pre>    <p>The script will take some time to run, and need to send around 6000 requests to the server.</p>    <figure class="wp-block-image size-large"><img loading="lazy" width="983" height="514" src="./images/billede-6.png" alt="" class="wp-image-673"/></figure>    <p>The challenge has been solved! To fix this and make it secure I would:</p>    <ul><li>Use a new IV for each encryption.</li><li>Not replace null bytes in the OTP.</li></ul>    <p>Thanks for reading!</p>     </div><!-- .entry-content -->  	</article><!-- #post-671 -->             </div> 	                </div>     </main><!-- #main -->   <footer id="colophon" class="c-footer site-footer">     <div class="c-footer__top">         <div class="c-footer__top__back-to-top">             <a aria-label="Back to Top" class="c-footer__top__back-to-top__link" href="#masthead">                 <span class="dashicons dashicons-arrow-up-alt2"></span>             </a>         </div>     </div>     <div class="c-footer__bottom site-info">         <div class="u-default-max-width">             <div class="c-footer__grid">                 <div class="c-footer__copyright"> 	                                        <div class="c-footer__branding s-footer-branding">                                         <a class="c-footer__branding__title h1" href="https://0xli.me/" rel="home">0xlimE Writeup blog</a> 		                        </div> 	                                    <p> 					                    </p>                 </div>                             </div>         </div><!-- .site-info -->     </div> </footer><!-- #colophon -->  </div><!-- #page -->  <script src='./js/wp-meliora-js-navigation.js' id='wp_meliora-navigation-js'></script> <script src='./js/wp-meliora-js-vendor.min.js' id='wp_meliora-carousel-js'></script> <script src='./js/wp-meliora-js-main.js' id='wp_meliora-main-js'></script> <script src='./js/enlighter-cache-enlighterjs.min.js' id='enlighterjs-js'></script> <script id='enlighterjs-js-after'>
!function(e,n){if("undefined"!=typeof EnlighterJS){var o={"selectors":{"block":"pre.EnlighterJSRAW","inline":"code.EnlighterJSRAW"},"options":{"indent":4,"ampersandCleanup":true,"linehover":true,"rawcodeDbclick":false,"textOverflow":"scroll","linenumbers":true,"theme":"enlighter","language":"generic","retainCssClasses":false,"collapse":false,"toolbarOuter":"","toolbarTop":"{BTN_RAW}{BTN_COPY}{BTN_WINDOW}{BTN_WEBSITE}","toolbarBottom":""}};(e.EnlighterJSINIT=function(){EnlighterJS.init(o.selectors.block,o.selectors.inline,o.options)})()}else{(n&&(n.error||n.log)||function(){})("Error: EnlighterJS resources not loaded yet!")}}(window,console);
</script> <script src='./js/yn2-wp-embed.min.js' id='wp-embed-js'></script>  </body> </html>